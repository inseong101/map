<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>소아과학 마인드맵</title>
  <style>
    body { margin:0; height:100vh; display:flex; flex-direction:column; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; }
    header { padding:10px 14px; border-bottom:1px solid rgba(0,0,0,.08); display:flex; gap:10px; align-items:center; }
    header a { color:#06f; text-decoration:none; }
    header .title { font-weight:700; }
    #container { flex:1; position:relative; }
    #mindmap { position:absolute; inset:0; }
    #status { color:#666; }
  </style>

  <!-- ✅ 순서 중요: d3 -> markmap-lib(UMD) -> markmap-view(UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.10/dist/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.10/dist/index.umd.min.js"></script>
</head>
<body>
  <header>
    <a href="./">← 목록</a>
    <span class="title" id="title">소아과학 마인드맵</span>
    <span id="status"></span>
  </header>
  <div id="container">
    <svg id="mindmap"></svg>
  </div>

  <!-- ✅ 라이브러리 로드가 끝난 뒤 실행 -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      const file = params.get('file') || 'md/1.md';

      const titleEl = document.getElementById('title');
      const statusEl = document.getElementById('status');
      const svg = document.getElementById('mindmap');

      titleEl.textContent = `마인드맵: ${file.split('/').pop()}`;

      async function loadMarkdown(url) {
        statusEl.textContent = `로딩 중… (${url})`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`fetch ${res.status} ${res.statusText}`);
        return await res.text();
      }

      function firstHeading(md) {
        const m = md.match(/^\s{0,3}#{1,6}\s+(.+)$/m);
        return m ? m[1].trim() : null;
      }

      (async () => {
        try {
          // ✅ 여기서 window.markmap이 이미 준비돼 있어야 함
          const { Transformer, Markmap } = window.markmap;

          const md = await loadMarkdown(file);
          const h = firstHeading(md);
          if (h) titleEl.textContent = h;

          const transformer = new Transformer();
          const { root } = transformer.transform(md);

          const mm = Markmap.create(svg, { fit: true }, root);
          window.addEventListener('resize', () => mm.fit());
          statusEl.textContent = '';
        } catch (e) {
          console.error(e);
          statusEl.textContent = '로드 실패';
          alert('마크다운을 불러오지 못했습니다: ' + e.message);
        }
      })();
    });
  </script>
</body>
</html>
